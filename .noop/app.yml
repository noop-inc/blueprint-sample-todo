---
components:
  - name: express
    type: service
    image: node:16-alpine
    root: service/express/
    port: 3000
    build:
      steps:
        - directory: /express
        - copy: package*.json
          destination: ./
        - run: npm ci
        - copy: index.js
        - copy: dynamodb.js
        - copy: s3.js
    runtime:
      command: npm start
      resources:
        - TodoItems
        - TodoUploads
      variables:
        AWS_REGION:
          $env: region
        DYNAMODB_TABLE:
          $resources: TodoItems.tableName
        DYNAMODB_ENDPOINT:
          $resources: TodoItems.endpoint
        S3_BUCKET:
          $resources: TodoUploads.bucket
        S3_ENDPOINT:
          $resources: TodoUploads.endpoint
  - name: react
    type: service
    image: node:16-alpine
    root: static/react/
    port: 4173
    build:
      steps:
        - directory: /react
        - copy: package*.json
          destination: ./
        - run: npm ci
        - copy: index.html
        - copy: vite.config.js
        - copy: public/
        - copy: src/
        - run: npm run build
    runtime:
      command: npm run preview
routes:
  - pattern: /api/**
    target:
      component: express
  - target:
      component: react
resources:
  - name: TodoItems
    type: dynamodb
    hashKeyName: id
    hashKeyType: S
  - name: TodoUploads
    type: s3
